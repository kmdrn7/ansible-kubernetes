##################################################
# Configure Common Server Setting
##################################################

- name: Switch off swap
  command: swapoff -a

- name: Disable Swap in /etc/fstab
  mount:
    name: swap
    fstype: swap
    state: absent

- name: Disabled /swap on fstab
  replace:
    dest: /etc/fstab
    regexp: '^/swapfile'
    replace: '#/swapfile'

- name: Add br_netfilter module
  modprobe:
    name: br_netfilter
    state: present

- name: Enable ipv4 forwarding, iptable bridge
  sysctl:
    name: "{{ item }}"
    value: '1'
    sysctl_file: /etc/sysctl.d/11-kubernetes.conf
    sysctl_set: yes
    reload: yes
  loop:
    - net.ipv4.ip_forward
    - net.bridge.bridge-nf-call-iptables
    - net.bridge.bridge-nf-call-ip6tables

- name: Check route to docker network on 172.17.0.0/24
  shell: ip route list | grep 172.17.0.0/24 | cat
  register: docker_route_check

- name: Add route to docker network on 172.17.0.0/24
  command: ip route add 172.17.0.0/24 via 192.168.10.1 dev eth1
  when: not docker_route_check.stdout

- name: Enable firewall service
  systemd:
    name: firewalld
    state: started
    enabled: yes

- name: Install nfs-utils
  yum:
    name: nfs-utils
    state: present